\chapter{Noise}

Noise in digital signals refers to any unwanted or unintended
alteration of the original signal, which can corrupt the information
being transmitted or processed. In other words, noise is any
interference that distorts a \emph{clean} signal.

\section{Zero-mean Additive White Gaussian (ZAWG) noise}
\gls{ZAWG} noise is a type of random noise characterized by the
following properties:
\begin{enumerate}
\item The expected value of the noise sequence of samples
  $\mathbf{n}$ is zero:
  \begin{equation}
    \mathbb{E}(\mathbf{n})=0.
  \end{equation}
\item The noise is added to the signal rather than multiplied or
  otherwise interacting with it:
  \begin{equation}
    \hat{\mathbf s} = {\mathbf s} + {\mathbf n},
  \end{equation}
  where $\mathbf{s}$ is the \emph{clean} signal (without noise, ground
  truth usually unknown), $\hat{\mathbf{s}}$ is the noisy signal, and
  ${\mathbf n}$ is a sequence of random samples with the same shape
  than $\mathbf{s}$. Notice that this is a
  signal-independent model because nothing can said about ${\mathbf n}$
  known $\hat{\mathbf s}$, except that
  \begin{equation}
    \Pr(\mathbf{s}{=}\mathbf{s}_i|\hat{\mathbf{s}}) = \Pr(\mathbf{s}{=}\mathbf{s}_i).
  \end{equation}
\item The noise has a constant \gls{PSD} over all frequencies (in
  other words, the spectrum of \gls{ZAWG} noise is flat). In discrete
  terms:
  \begin{equation}
    \mathbb{E}(\mathbf{n}_i\mathbf{n}_j) = 0 \quad \text{for} \quad i\neq j.
  \end{equation}
\item The noise samples follow a Gaussian (normal) distribution,
  centered at zero:
  \begin{equation}
    {\mathbf n}\sim{\mathcal N}(\mu=0,\sigma).
  \end{equation}
\end{enumerate}

\section{Poisson noise}

Poisson noise is a type of signal-dependent noise that arises in
systems where the measured data represent counts of discrete events
(e.g., photons, electrons). It is particularly relevant in
low-radiation imaging, and quantum physics.

Poisson noise can be generated as
\begin{equation}
  \hat{\mathbf{s}} = \frac{\mathbf{n}(\mathbf{s})}{\gamma},~\mathbf{n}\sim\mathcal{P}(\lambda=\gamma\mathbf{s}),
  \label{eq:PN}
\end{equation}
  where $\gamma$ controls the standard deviation (the higher $\gamma$,
the smaller the deviation from the $\mathbf{s}$ values). As can be
seen, this is a signal-dependent model because the brighter parts of
$\hat{\mathbf s}$ will have a higher mean and variance\footnote{The
  mean and variance of a Poisson law are both equal to $\lambda$.},
and therefore a higher noise level \cite{meiniel2018denoising}.

\section{Mixed Poisson-Gaussian (MPG) noise}
%{{{

A more realistic noise model in contexts such as in microscopy
consists in a combination of both Poisson and \gls{ZAWG} noise, which
is commonly called \gls{MPG} noise \cite{meiniel2018denoising},
generated as
\begin{equation}
  \hat{\mathbf s} = (1-\alpha)(\mathbf{s} + {\mathbf s}_{\mathcal{N}(\sigma)}) + \alpha{\mathbf n}_{\mathcal{P}(\lambda=\gamma\mathbf{s})}/\gamma,
  \label{eq:MPG_noise_model} 
\end{equation}
where $\alpha\in[0,~1]$ controls the ratio of both types of
noise. Therefore, for $\alpha > 0$,\footnote{If $\sigma=0$ and
$\alpha=0$, both types of noise vanish and
$\hat{\mathbf{s}}=\mathbf{s}$.} the noise is signal-dependent and it's
spectrum resembles the spectrum of $\mathbf{x}$. By default, in our
experiments, $\alpha=0.5$.

%In this case, we have that
%\begin{equation}
%  \Pr({\mathbf n}{=}k) = \frac{e^{-\lambda}}{\sqrt{2\pi}\sigma}\sum_{p=0}^{\infty}\frac{\lambda^p}{p!} e^{-\frac{\gamma p - k}{2\sigma^2}},
%  \label{eq:MPGN}
%\end{equation}
%and that
%\begin{equation}
%  \hat{\mathbf s} = (1-\alpha)(\mathbf{s} + {\mathbf s}_{\mathcal{N}(\sigma)}) + \alpha{\mathbf n}_{\mathcal{P}(\lambda=\gamma\mathbf{s})}/\gamma,
%  \label{eq:MPG_noise_model} 
%\end{equation}
%where $\alpha\in[0,~1]$ controls the ratio of both types of
%noise. Therefore, for $\alpha > 0$,\footnote{If $\sigma=0$ and
%$\alpha=0$, both types of noise vanish and
%$\hat{\mathbf{s}}=\mathbf{s}$.} the noise is signal-dependent and it's
%spectrum resembles the spectrum of $\mathbf{x}$. By default, in our
%experiments, $\alpha=0.5$.

% A. Foi, M. Trimeche, V. Katkovnik, and K. Egiazarian.
% Practical Poissonian-Gaussian noise modeling and fitting for
% single-image raw-data. IEEE Transactions on Image Pro-
% cessing, 17(10):1737–1754, 2008.

%}}}


%\subsection{Noise estimation}
%{{{

% Makitalo and A. Foi. Optimal inversion of the generalized
% Anscombe transformation for Poisson-Gaussian noise. IEEE
% Transactions on Image Processing, 22(1):91–103, 2013.
% https://link.springer.com/chapter/10.1007/978-3-030-87231-1_33

% A. Foi, M. Trimeche, V. Katkovnik, and K. Egiazarian.
% Practical Poissonian-Gaussian noise modeling and fitting for
% single-image raw-data. IEEE Transactions on Image Pro-
% cessing, 17(10):1737–1754, 2008.

%}}}

%\subsection{The Anscombe transform and generalized Anscombe transformation (GAT)}
%{{{

% Using a nonlinear variance-stabilizing transformation (VST) to convert the
% Poisson-Gaussian denoising problem into a Gaussian noise
% removal problem. The VST is able to remove the signal-dependency of
% the Poisson component, whose noise variance varies with
% the expected pixel value, and results in a modified image
% with signal-independent Gaussian noise only and a constant
% (unitary) noise variance. Next, a Gaussian denoising algo-
% rithm is applied to the transformed image. And finally, the
% Gaussian-denoised data is transformed back via an inverse
% VST algorithm, such as the exact unbiased inverse transfor-
% mation [19], and the estimation of the noise-free image is
% obtained.

% https://arxiv.org/abs/2209.09825?utm_source=chatgpt.com
% . Makitalo and A. Foi. Optimal inversion of the generalized
% Anscombe transformation for Poisson-Gaussian noise. IEEE
% Transactions on Image Processing, 22(1):91–103, 2013.

% [19] M. Makitalo and A. Foi. Optimal inversion of the generalized
% Anscombe transformation for Poisson-Gaussian noise. IEEE
% Transactions on Image Processing, 22(1):91–103, 2013.

% En "A Poisson-Gaussian Denoising Dataset with Real Fluorescence Microscopy
% Images" hay una definición de la transformada (Eq. 4).

%}}}

%\subsection{Speckle noise}
%{{{

% Speckle noise is generated in optical devices that use coherent light sources (lasers), such as in fluorescence microscopy \cite{kumar2021speckle}. Speckle noise is signal-dependent, so its variance changes with the intensity of the true image. It has been modeled as zero-mean multiplicative Gaussian noise \cite{} and as Rice noise \cite{}.

% Multiplicative zero-mean Gaussian noise, modeled as
%   \begin{equation}
%     \hat{\mathbf X}^{(i)} = {\mathbf X} (1 + {\mathbf N}^{(i)}),
%     \label{eq:MGN}
%   \end{equation}
%   where ${\mathbf N}\sim{\mathcal N}(\mu,\sigma)$. This is a signal-dependent noise present
%   in synthetic aperture radar (SAR) and ultrasound images is usually
%   considered speckle noise.
  
%   Another distribution used for modeling speckle noise is the Rice
%   distribution ($\mathbf{N}\sim\mathrm{Rice}(\nu,\sigma)$), with PDF
%   \begin{equation}
%     f(x; \nu,\sigma) = \Pr({\mathbf N}^{(i)}_j{=}x) = \frac{x}{\sigma^2}e^{\frac{-(x^2+\nu^2)}{2\sigma^2}}I_0\left(\frac{x\nu}{\sigma^2}\right),
%   \end{equation}
%   where $x$ is continuous, and $I_o$ is the modified Bessel function
%   of the first kind with order zero. Rician noisy tensor instances can
%   be generated with
%   \begin{equation}
%     \hat{\mathbf X}^{(i)} = \sqrt{ ({\mathbf X} + {\mathbf N}_{\text{real}}^{(i)})^2 + ({\mathbf N}_{\text{imag}}^{(i)})^2}.
%   \end{equation}
%   %Notice that the Rayleigh distribution ($\mathbf{N}\sim\mathrm{Rayleigh}(\sigma)$),
%   %which is defined by the PDF
%   %\begin{equation}
%   %  {\mathbf N}^{(i)} \sim f(x; \sigma) = \frac{x}{\sigma^2} e^{-x^2/(2\sigma^2)}, \quad x \geq 0,
%   %\end{equation}
%   %continuous both, $x$ and $\sigma$ (the scale parameter) is a
%   %particular case of Rice distribution when $\nu=0$.
%   Notice that, even being $\nu=0$ (in whose case we are working with
%   the Rayleigh distribution
%   ($\mathbf{N}\sim\mathrm{Rayleigh}(\sigma)$)), the mean of the noise
%   is not zero. The noise that corrupts magnetic resonance images is
%   usually modeled as Rician/Rayleigh noise.

%}}}

% \section{Noise models}
%{{{

% \label{sec:noise_models}

% Let $\mathbf{X}$ be a \emph{clean signal} (without noise, ground truth
% usually unknown) tensor, and $\hat{\mathbf X}^{(i)}$ the $i$-th
% noisy-version tensor random instance of $\mathbf{X}$ generated, in
% general, through
% \begin{equation}
%   \hat{\mathbf X}^{(i)} = f(\mathbf{X}, \mathbf{N}^{(i)}),
%   \label{eq:general_model}
% \end{equation}
% where ${\mathbf N}^{(i)}$ an $i$-th (unknown) noise tensor instance
% with the same shape as $\mathbf{X}$.

% We assume that ${\mathbf X}$ and $\mathbf{N}$ are statistically
% independent, and therefore, nothing can be said about
% ${\mathbf N}^{(i)}$ if we know $\hat{\mathbf X}^{(i)}$, and
% viceversa, and therefore, it is impossible to obtain ${\mathbf X}$
% from a single $\hat{\mathbf X}^{(i)}$.

% \subsection{Signal-independent noise model}
% In SIN (signal-independent noise) models, the noise is statistically i.i.d. (independent and
% identically distributed), i.e., the random values of ${\mathbf N}^{(i)}$ satisfy that
% \begin{equation}
%   {\mathbb E}[\{{\mathbf N}^{(i)}_j\}_{j=1}^J]=\frac{1}{J} \sum_{i=1}^J {\mathbf N}_j^{(i)}=\overline{\mathbf N}^{(i)},
%   \label{eq:noise_expectation_1}
% \end{equation}
% where ${\mathbf N}^{(i)}_j$ is the $j$-th (scalar) value
% of ${\mathbf N}^{(i)}$, and
% \begin{equation}
%   J=\prod_{k=1}^D \mathbf{X}.\text{shape}[k],
% \end{equation}
% being $D$ the number of dimensions of the signal (in microscopy, usually 2 or 3).

% SIN models are also called additive noise models defined by
% \begin{equation}
%   \hat{\mathbf X}^{(i)} = {\mathbf X} + {\mathbf N}^{(i)}.
%   \label{eq:additive_noisy_model}
% \end{equation}

% \subsection{Signal-dependent noise (SDN) models}
% In SDN models, the amplitude of the random noise samples depends on
% the clean signal (see Eq.~\ref{eq:general_model}).

% %\begin{equation}
% %  \hat{\mathbf X}^{(i)} = \mathbf{X} + {\mathbf N}^{(i)}(\mathbf{X}),
% %  \label{eq:SDN_model}
% %\end{equation}

%}}}

%}}}

\section{Noise mesurement}
%{{{

When a clean signal is not available, it is necessary to use a
different kind of information that help us to (without any other
alternative) \emph{estimate} the characteristics of the noise in the
signal.

The two metrics included in this section are distortion metrics that
can help to determine resolution of a signal, for example, the maximum
spatial resolution that a microscope can achieve. In microscopy, we
use the \emph{resolving power} of the microscope, which is the
smallest distance $d$ between two points that can still be
distinguished (from a biological perspective) as separate entities
\cite{nieuwenhuizen2013measuring}. The idea is that, any frequency
above $1/d$ will be dominated by noise (or at least, information that
is not relevant), and therefore, a low-pass filter with a cut-off
frequency of $1/d$ should only remove noise.\footnote{Notice that
  $d/2$ could be the sampling step size used to digitalize the signal
  without lossing information.}

Therefore, characterization of noise (in terms of power, statistical
model, and spectral profile, etc.) can provide valuable insights for
determining the optimal operational parameters of denoising
algorithms. However, this approach typically necessitates the
availability of at least two independent noisy realizations of the
underlying clean signal, $\mathbf{s}^{(1)}$ and
$\mathbf{s}^{(2)}$.

\begin{comment}
%{{{

Noise can be additive or multiplicative. In the first case, noise is
signal independent between samples of the same signal instance, and
between samples of different instances, even if we consider the same
sample index. In the second case, the power of the noise depends on
the power of the signal, and therefore, if we can estimate the signal,
we can estimate, for example, the local variance of the noise after
supposing some statistical model. Notice, however, that in any case,
we must known, at least two (inevitable noisy) instances of the clean
signal.

%}}}
\end{comment}

\begin{comment}
%{{{

This requirement often presents a significant
challenge, particularly in contexts where samples are susceptible to
the degradation caused by the microscope radiation, thereby limiting
the feasibility of acquiring multiple such instances.

When this is not possible, one way to simulate having two or more
noisy instances of the same clean signal is to distribute the
pixels/voxels across two or more images/volumes (see Appendices
\ref{sec:EOS}, \ref{sec:CBS}, \ref{sec:ICBS}, \ref{sec:SCBS}, and
\ref{sec:SPRS}). Unfortunately, the splitting reduces the spatial
resolution at which the signal/noise parameters can be successfully
estudied.

%}}}
\end{comment}

\subsection{Fourier Shell Correlation (FSC) and Fourier Ring
  Correlation (FRC)}
\label{sec:fourier_correlation}
%{{{

The
\href{https://en.wikipedia.org/wiki/Fourier_shell_correlation}{\gls{FSC}}
curve measures the similarity between two 3D volumes represented in
the Fourier domain \cite{verbeke2024self} (for the 2D case, the
equivalent metric is \gls{FRC}). Each point of the curve prepresents
the normalized cross-correlation between two ``shells'' (``rings'' in
2D) of Fourier coefficients of both volumes (images). Correlation in
the Fourier domain has become the universal resolution metric and is
used to assess the quality of 3D reconstructions
\cite{rosenthal2003optimal,scheres2012prevention}.

\begin{comment}
%{{{

An advantage of correlation in the Fourier domain (FC\footnote{When
  the number of dimensions is not relevant, we will refer to this
  metric simply by FC (Fourier Correlation).}) over other similarity
metrics such as RMSE, SSIM or PPC is that FC values depend on the
frequency, and this can be interesting in some scenarios, such as
microscopy, where the resolution of the microscope is finite and known
a priori \cite{nieuwenhuizen2013measuring}. Notice that, with this
information, we can know whether the denoising is removing the
high-frequency components of the clean signal, or on the contrary,
basically noise.\footnote{When the SNR is very low, the Fourier
  coefficients of the same ring/shell of two different noisy versions
  of the same signal are uncorrelated and therefore, the corresponding
  curves values should be close to zero.}  For this reason, in some
fields such as single particle electron cryo-microscopy (cryo-EM),

%}}}
\end{comment}

A FSC value of the FSC curve is determined\footnote{An similar
  definition there exists for the FRC.} by~\cite{verbeke2024self}
\begin{equation}
  \text{FSC}(\mathbf{s}^{(1)}, \mathbf{s}^{(2)}; r) = \frac{\sum_{i \in S_r} \mathbf{S}^{(1)}_i {\mathbf{S}^{(2)}_i}^*}{\sqrt{\sum_{i \in S_r} |\mathbf{S}^{(1)}_i|^2 \sum_{i \in S_r} |\mathbf{S}^{(2)}_i|^2}},
  \label{eq:FSC}
\end{equation}
where $i=(x, y, z)$ is a point (a coordinate of a Fourier coefficient)
of the surface of the sphere $S_r$ defined by $x^2+y^2+z^2=r^2$.
%}}}

\subsection{Self Fourier Correlation (SFC)}
%{{{

Unfortunately, the existence of two noisy instances (see
$\mathbf{s}^{(1)}$ and $\mathbf{s}^{(2)}$ in Eq.~\ref{eq:FSC}) of the
clean signal $\mathbf{s}$ not always is possible in
practice (see Section~\ref{sec:why_denoising})
In this case, a workaround is to simulate such existence, by
distributing the information of the only image we have
$\mathbf{s}^{(1)}$ between two noisy (sub-)instances
$\mathbf{s}^{(1.1)}$ and $\mathbf{s}^{(1.2)}$. For example, in
\cite{verbeke2024self} a even/odd signal splitting (see
Appendix~\ref{sec:EOS}) in 2D slices is proposed to compute the
\gls{SFC}. In \cite{koho2019fourier} a subsampled-chessboard splitting
pattern (see Appendix~\ref{sec:SCBS}) is used. Other ``splitting''
techniques are described in Appendices \ref{sec:ICBS}, \ref{sec:SCBS},
and \ref{sec:SPRS}. Unfortunately, the splitting reduces the spatial
resolution at which the signal/noise parameters can be successfully
estudied (for example, in \cite{verbeke2024self} the \gls{SFC} that
resembles the true FC only in some specific cases\footnote{Gaussian noise
  distribution must be white, and the power spectrum of the signal
  decays.} and in \cite{koho2019fourier}, the \gls{SFC} curves must be calibrated
depending on the correlation). Therefore, in general, we should always
consider \gls{SFC} curves as estimations of the true FC curves.

Finally, notice that, although the FC and the SFC curves can be traced
using only 2 signals, more accurate estimations can be obtained if
more instances are available, plotting the arithmetic mean of all of
them. For example, in the case of SCBS the we average 2 curves, and in
the case of SPRS the number of averaged curves can be choosen by the
user.

\begin{comment}
Finally, notice that it is possible to compute the so called Self FC
(SFC in general, specifically SFSC for the 3D case and SFRC for the 2D
one), using some technique to simulate the existence of (at
least\footnote{When it is possible to use more instances, the
  resulting curve is the mean of all the curves.}) two
``noisy''\footnote{In real scenarios, where it is possible to take two
  (or more) captures of the same view, the only that should
  distinguish the instances is the noise. Notice that, if the views
  were different, the uncorrelated noise is also present.} instances,
$\hat{\mathbf{X}}^{(1)}$ and $\hat{\mathbf{X}}^{(2)}$. For example, in
\cite{verbeke2024self} a even/odd signal splitting (see
Appendix~\ref{sec:EOS}) in 2D slices is proposed to compute the SFC
that resembles the true FC in some specific cases. In
\cite{koho2019fourier} a subsampled-chessboard splitting pattern (see
Appendix~\ref{sec:SCBS}) is used to compute SFC curves. Notice that,
to resemble the true FC curves, they must be calibrated for some
correlation threshold.
\end{comment}

\begin{figure}
  \centering
  \resizebox{1.0\textwidth}{!}{
    \renewcommand{\arraystretch}{0.0} % Adjust row spacing in the table
    \setlength{\tabcolsep}{0ex}      % Adjust column spacing in the table    
    \begin{tabular}{ccc}
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_FISH_clean.ipynb}{\includegraphics{Confocal_FISH_clean.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_MICE_clean.ipynb}{\includegraphics{TwoPhoton_MICE_clean.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_MICE_clean_SFRC.ipynb}{\includegraphics{Confocal_MICE_clean.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_FISH_clean_SFRC.ipynb}{\includegraphics{Confocal_FISH_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_MICE_clean_SFRC.ipynb}{\includegraphics{TwoPhoton_MICE_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_MICE_clean_SFRC.ipynb}{\includegraphics{Confocal_MICE_clean_SFRC.pdf}}
    \end{tabular}
  }
  \caption{SFRC (Self Fourier Ring Correlation) of clean images
    (generated by averaging (arithmetic mean) 50 noisy
    instances~\cite{zhang2019poisson}) using different
    data-splitting/shuffling algoritms: \acrshort{EOS}, \acrshort{CBS}, \acrshort{ICBS}, \acrshort{SCBS}, and \acrshort{SPRS}. SPRS curves have been computed using faded
    margins. \label{fig:SFC_vs_splitting_clean}}
\end{figure}

\begin{figure}
  \centering
  \resizebox{1.0\textwidth}{!}{
    \renewcommand{\arraystretch}{0.0} % Adjust row spacing in the table
    \setlength{\tabcolsep}{0ex}      % Adjust column spacing in the table    
    \begin{tabular}{ccc}
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_R_clean_SFRC.ipynb}{\includegraphics{Confocal_BPAE_R_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_G_clean_SFRC.ipynb}{\includegraphics{Confocal_BPAE_G_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_B_clean_SFRC.ipynb}{\includegraphics{Confocal_BPAE_B_clean_SFRC.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_R_clean_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_R_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_G_clean_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_G_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_B_clean_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_B_clean_SFRC.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_R_clean_SFRC.ipynb}{\includegraphics{WideField_BPAE_R_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_G_clean_SFRC.ipynb}{\includegraphics{WideField_BPAE_G_clean_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_B_clean_SFRC.ipynb}{\includegraphics{WideField_BPAE_B_clean_SFRC.pdf}}
    \end{tabular}
  }
  \caption{More SFRC curves of clean images. SPRS curves have been
    computed using faded margins.\label{fig:more_clean_SRFC}}
\end{figure}

Fig.~\ref{fig:SFC_vs_splitting_clean} shows a comparison between
several SFRC curves obtained using different techniques for generating
the instances of a single \emph{clean}\footnote{Generated by
  computing the arithmetic mean of the pixels of several noisy
  instances \cite{zhang2019poisson}.} input image. Ideally, the dynamic
range of the FC curves should be [0, 1].

\begin{figure}
  \centering
  \resizebox{1.0\textwidth}{!}{
    \renewcommand{\arraystretch}{0.0} % Adjust row spacing in the table
    \setlength{\tabcolsep}{0ex}      % Adjust column spacing in the table    
    \begin{tabular}{ccc}
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_FISH_noisy.ipynb}{\includegraphics{Confocal_FISH_noisy.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_MICE_noisy.ipynb}{\includegraphics{TwoPhoton_MICE_noisy.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_MICE_noisy.ipynb}{\includegraphics{Confocal_MICE_noisy.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_FISH_noisy_SFRC.ipynb}{\includegraphics{Confocal_FISH_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_MICE_noisy_SFRC.ipynb}{\includegraphics{TwoPhoton_MICE_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_MICE_noisy_SFRC.ipynb}{\includegraphics{Confocal_MICE_noisy_SFRC.pdf}}
    \end{tabular}
  }
  \caption{SFRC (Self Fourier Ring Correlation) of three noisy
    images \cite{zhang2019poisson} using different
    data-splitting/shuffling algoritms (see
    Fig.~\ref{fig:SFC_vs_splitting_noisy}). For the purpose of
    comparison, it has also been show the FRC using another noisy
    instance of $\mathbf{s}$ (concretelly, we have shown
    FSC($\mathbf{s}^{(1)}$,
    $\mathbf{s}^{(2)}$)).\label{fig:SFC_vs_splitting_noisy}}
\end{figure}

\begin{figure}
  \centering
  \resizebox{1.0\textwidth}{!}{
    \renewcommand{\arraystretch}{0.0} % Adjust row spacing in the table
    \setlength{\tabcolsep}{0ex}      % Adjust column spacing in the table    
    \begin{tabular}{ccc}
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_R_noisy_SFRC.ipynb}{\includegraphics{Confocal_BPAE_R_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_G_noisy_SFRC.ipynb}{\includegraphics{Confocal_BPAE_G_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_B_noisy_SFRC.ipynb}{\includegraphics{Confocal_BPAE_B_noisy_SFRC.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_R_noisy_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_R_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_G_noisy_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_G_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_B_noisy_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_B_noisy_SFRC.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_R_noisy_SFRC.ipynb}{\includegraphics{WideField_BPAE_R_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_G_noisy_SFRC.ipynb}{\includegraphics{WideField_BPAE_G_noisy_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_B_noisy_SFRC.ipynb}{\includegraphics{WideField_BPAE_B_noisy_SFRC.pdf}}
    \end{tabular}
  }
  \caption{More SFRC curves of noisy images.\label{fig:more_noisy_SRFC}}
\end{figure}

Fig.~\ref{fig:SFC_vs_splitting_noisy} shows a comparison between FRC
and SFRC curves obtained using different techniques for generating the
instances of a single input noisy image.

\begin{figure}
  \centering
  \resizebox{1.0\textwidth}{!}{
    \renewcommand{\arraystretch}{0.0} % Adjust row spacing in the table
    \setlength{\tabcolsep}{0ex}      % Adjust column spacing in the table    
    \begin{tabular}{ccc}
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_FISH_artificial_SFRC.ipynb}{\includegraphics{Confocal_FISH_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_MICE_artificial_SFRC.ipynb}{\includegraphics{TwoPhoton_MICE_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_MICE_artificial_SFRC.ipynb}{\includegraphics{Confocal_MICE_artificial_SFRC.pdf}}
    \end{tabular}
  }
  \caption{SFRC (Self Fourier Ring Correlation) of three MPG
    \emph{artificially-noisy} images using different
    data-splitting/shuffling algoritms (see
    Fig.~\ref{fig:SFC_vs_splitting_noisy}). The parameters for SPRS
    are the same than the obtained the (true-) noisy
    images.\label{fig:SFC_vs_splitting_artificial}}
\end{figure}

\begin{figure}
  \centering
  \resizebox{1.0\textwidth}{!}{
    \renewcommand{\arraystretch}{0.0} % Adjust row spacing in the table
    \setlength{\tabcolsep}{0ex}      % Adjust column spacing in the table    
    \begin{tabular}{ccc}
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_R_artificial_SFRC.ipynb}{\includegraphics{Confocal_BPAE_R_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_G_artificial_SFRC.ipynb}{\includegraphics{Confocal_BPAE_G_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/Confocal_BPAE_B_artificial_SFRC.ipynb}{\includegraphics{Confocal_BPAE_B_artificial_SFRC.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_R_artificial_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_R_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_G_artificial_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_G_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/TwoPhoton_BPAE_B_artificial_SFRC.ipynb}{\includegraphics{TwoPhoton_BPAE_B_artificial_SFRC.pdf}} \\
      \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_R_artificial_SFRC.ipynb}{\includegraphics{WideField_BPAE_R_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_G_artificial_SFRC.ipynb}{\includegraphics{WideField_BPAE_G_artificial_SFRC.pdf}} & \href{https://nbviewer.org/github/vicente-gonzalez-ruiz/denoising/blob/main/notebooks/WideField_BPAE_B_artificial_SFRC.ipynb}{\includegraphics{WideField_BPAE_B_artificial_SFRC.pdf}}
    \end{tabular}
  }
  \caption{More SFRC curves of \emph{artificially-noisy} images. The
    parameters for SPRS are the same than the obtained by the (true-)
    noisy images.\label{fig:more_artificial_SRFC}}
\end{figure}

Fig.~\ref{fig:SFC_vs_splitting_artificial} shows a comparison
between FRC/SFRC curves obtained using different techniques for
generating the instances of a single input \emph{artificially-noisy}
image.

\begin{comment}
%{{{

Each point of a SFSC curve represents the correlation between the
Fourier coefficients extracted from the same subband (shell) from two
subsampled versions of the same signal, at the cost of reducing the
spatial resolution to the half of the original frequency (in each
signal dimension). This fact should be taked into account when we
consider the spatial resolution in any analysis that use the SFSC
curve instead of the FSC curve. For example, if we are using a
separable $N$-taps low-pass filter in the original resolution volume,
the equivalent ``SFSC-length'' filter would have had $N/2$ taps.

%}}}
\end{comment}

\begin{comment}
\section{Self Fourier correlation of random data}
\label{sec:SFC_random_data}
%{{{

In order to know the dynamic range of frequencies that we can use to
determine the cut-off frequency of a low-pass filter-based denoising
technique, in the Fig.~\ref{fig:SFC_random_data} has been shown for
both, the even/odd-splitting (EO) algorithm and the SPRS algorithm,
the SFC curve of an image with random information.

The coefficients of a
digital Gaussian filter can be generated with
\begin{equation}
  h[n] = \text{GF}_{\tau}(\delta[n]),
\end{equation}
where the function $\text{GF}(\cdot)$ represents a 1D GF, which in our
case is implemented using the method
\href{https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.gaussian_filter1d.html}{scipy.ndimage.gaussian\_filter1d()}. This method returns kernels with
\begin{equation}
  \mathbf{h}.\mathsf{size} = 2\lceil k\tau\rceil + 1,
\end{equation}
where $k=4$ provides enough accuracy in the
convolutions.\footnote{Notice that if $k$ grows then the cut-off
  frequency of the filter decreases, regardless of $\tau$.} Notice
that the filter is truncated at $\pm 4\tau$.

%}}}
\end{comment}


%}}}

\subsection{Spectral SNR (SSNR)}
\label{sec:SSNR}
%{{{

The \gls{SNR} in the frequency domain can be defined in terms of the
\gls{AC} (see Section~\ref{sec:autocorrelation}) of the signal
$\mathbf{s}$ and the \gls{CC} (see
Section~\ref{sec:cross-correlation}) between the signal and the noise
$\mathbf{n}$,
\begin{equation}
  % \text{SNR}(f) = \frac{R_{\mathbf{ss}}}{R_{\mathbf{sn}}}.
  \text{SNR}(f) = \frac{\text{CC}(\mathbf{s},\mathbf{s})}{\text{CC}(\mathbf{s},\mathbf{n})},
\end{equation}
where $f$ denotes frequency.

The SSNR can be estimated using the correlation in the Fourier domain
between two (or more, in this case, using the mean SSNR) instances
$\hat{\mathbf{X}}^{(1)}$ and $\hat{\mathbf{X}}^{(2)}$. For example, in
the 3D case (and we only have two instances)
\cite{unser1987new,verbeke2024self}, we have that
\begin{equation}
\text{SSNR}(\hat{\mathbf{X}}^{(1)}, \hat{\mathbf{X}}^{(2)}; f) = \frac{\text{FSC}(\hat{\mathbf{X}}^{(1)}, \hat{\mathbf{X}}^{(2)}; f)}{1-\text{FSC}(\hat{\mathbf{X}}^{(1)}, \hat{\mathbf{X}}^{(2)}; f)}.
\end{equation}

%}}}

%}}}

\begin{subappendices}

\section{Even-Odd Splitting (EOS)}
\label{sec:EOS}
%{{{

In the 2D case, \gls{EOS} generates
\begin{equation}
  \mathrm{EOS}(\mathbf{X})=\{\mathbf{X}^{(\text{VE})}, \mathbf{X}^{(\text{VO})}, \mathbf{X}^{(\text{HE})}, \mathbf{X}^{(\text{HO})}\},
\end{equation}
where $\mathbf{X}$ is the input image, and $\{\mathbf{X}^{(i)}\}_{i=\{\text{VE}, \text{VO}, \text{HE}, \text{HO}\}}$
  are the output images, where $\text{VE}=\text{vertical-even}$,
  $\text{VO}=\text{vertical-odd}$, $\text{HE}=\text{horizontal-even}$,
  and $\text{HO}=\text{horizontal-odd}$. Concretely,
  \begin{align}
    \mathbf{X}^{(\text{VE})}_{y,x} & = \mathbf{X}_{2y,x}, \\
    \mathbf{X}^{(\text{VO})}_{y,x} & = \mathbf{X}_{2y+1,x}, \\
    \mathbf{X}^{(\text{HE})}_{y,x} & = \mathbf{X}_{y,2x},\\
    \mathbf{X}^{(\text{VO})}_{y,x} & = \mathbf{X}_{y,2x+1}.
  \end{align}
  
%}}}

\section{ChessBoard Splitting (CBS)}
\label{sec:CBS}
%{{{

In the 2D case, \gls{CBS} generates two distinct
instances
\begin{equation}
  \mathrm{CBS}(\mathbf{X})=\{\mathbf{X}^{(\text{B})},\mathbf{X}^{(\text{W})}\},
\end{equation}
where $\mathbf{X}$ is the input image, and
$\{\mathbf{X}^{(\text{B})},\mathbf{X}^{(\text{W})}\}$ are the output
images. Defining a chessboard mask function
\begin{equation}
  M(y,x)=(y+x)~\text{mod}~2,
\end{equation}
the CBS algorithm consists of:
\begin{enumerate}
\item \textbf{Populate} $\mathbf{X}^{(\text{B})}$ \textbf{with
    ``black'' chessboard pixels from $\mathbf{X}$:} In an initially
  zero-image $\mathbf{X}^{(\text{B})}$, copy the ``black'' pixels from
  $\mathbf{X}$ to $\mathbf{X}^{(\text{B})}$:
  \begin{equation}
    \mathbf{X}^{(\text{B})}_{\{b\}} = \mathbf{X}_{\{b\}},
    \label{eq:copy_blacks}
  \end{equation}
  where ``B'' indicates ``black'', and
  \begin{equation}
    \{b\} = \{(y, x) \mid M(y, x)=0\}
    \label{eq:black_pixels}
  \end{equation}
  are the ``black'' pixel coordinates.
  
\item \textbf{Populate} $\mathbf{X}^{(\text{W})}$ \textbf{with
    ``white'' chessboard pixels from $\mathbf{X}$:} In an initially
  zero-image $\mathbf{X}^{(\text{W})}$, copy the corresponding pixels
  from $\mathbf{X}$ to $\mathbf{X}^{(\text{W})}$:
  \begin{equation}
    \mathbf{X}^{(\text{W})}_{\{w\}} = \mathbf{X}_{\{w\}},
    \label{eq:copy_whites}
  \end{equation}
  where ``W'' indicates ``white'', and
  \begin{equation}
    \{w\} = \{(y, x) \mid M(y, x)=1\}
    \label{eq:white_pixels}
  \end{equation}
  are the ``white'' pixel coordinates.
  
\end{enumerate}

%}}}

\section{Interpolated ChessBoard Splitting (ICBS)}
\label{sec:ICBS}
%{{{

\gls{ICBS} is an extension of \gls{CBS} (which must be run first, see
Appendix~\ref{sec:CBS}) where the $\{w\}$ (``white'') pixels involved
in Eq.~\ref{eq:copy_blacks} are interpolated using the $\{b\}$
(``black'') pixels (see Eq.~\ref{eq:black_pixels}), and
viceversa. Therefore,
\begin{equation}
  %\mathrm{ICBS}(\mathbf{X})=\{\mathbf{X}^{(b)},\mathbf{X}^{(w)}\},
  \mathrm{ICBS}(\mathbf{X})=\{\mathbf{X}^{(\text{B})},\mathbf{X}^{(\text{W})}\}=\{\text{CBS}(\mathbf{X})_0 + \mathbf{X}^{(b')},\text{CBS}(\mathbf{X})_1 + \mathbf{X}^{(w')}\},
\end{equation}
where $\mathbf{X}$ is the input image, and the new output pixels of
$\mathbf{X}^{(\text{B})}$ and $\mathbf{X}^{(\text{W})}$ are
\begin{equation}
  \mathbf{X}^{(\text{B}')}_{(y,x)\in\{w\}} = \frac{1}{4}(\mathbf{X}_{(y-1,x)}+\mathbf{X}_{(y+1,x)}+\mathbf{X}_{(y,x-1)}+\mathbf{X}_{(y,x+1)}),
\end{equation}
and
\begin{equation}
  \mathbf{X}^{(\text{W}')}_{(y,x)\in\{b\}} = \frac{1}{4}(\mathbf{X}_{(y-1,x)}+\mathbf{X}_{(y+1,x)}+\mathbf{X}_{(y,x-1)}+\mathbf{X}_{(y,x+1)}).
\end{equation}

%}}}

\section{Subsampled ChessBoard Splitting (SCBS)}
\label{sec:SCBS}
%{{{

\gls{SCBS} \cite{koho2019fourier} decomposes an input image $\mathbf{X}$
into four distinct sub-images
\begin{equation}
  \mathrm{SCS}(\mathbf{X}) = \{\mathbf{X}^{(\text{OO})}, \mathbf{X}^{(\text{EE})}, \mathbf{X}^{(\text{OE})}, \mathbf{X}^{(\text{EO})} \},
\end{equation}
where
\begin{align}
  \mathbf{X}^{(\text{OO})} & = (\mathbf{X}_{\{o\},:})_{:,\{o\}}, \text{(pixels with odd row and odd column indices)} \\
  \mathbf{X}^{(\text{EE})} & = (\mathbf{X}_{\{e\},:})_{:,\{e\}}, \text{(pixels with even row and even column indices)}\\
  \mathbf{X}^{(\text{OE})} & = (\mathbf{X}_{\{o\},:})_{:,\{e\}}, \text{(pixels with odd row and even column indices)}\\
  \mathbf{X}^{(\text{EO})} & = (\mathbf{X}_{\{e\},:})_{:,\{o\}}, \text{(pixels with even row and odd column indices)}
\end{align}
where
\begin{align}
  \{o\} = \{i\mid M(i)=1\}, \\
  \{e\} = \{i\mid M(i)=0\},
\end{align}
where
\begin{equation}
  M(i) = i~\text{mod}~2,
\end{equation}
and $\mathbf{X}_{i,:}$ denotes the $i$-th row of $\mathbf{X}$, and
$\mathbf{X}_{:,i}$ the $i$-th column of $\mathbf{X}$.

%}}}

\section{Structure Preserving Random Shuffling (SPRS)}
\label{sec:SPRS}
%{{{

\gls{SPRS} can be used to generate similar instances of an image or volume
$\mathbf{s}$. We deonote this as
\begin{equation}
  \mathrm{SPRS}(\mathbf{s}; n, \sigma) = \{\mathbf{s}, \mathbf{s}^{(i)}\}_{i=1}^n,
\end{equation}
where $n\ge 1$ controls the number of generated instances, and
$\sigma$ is the standard deviation of the normal distribution that a
random numbers generator follows to produce, in each run, a different
instance. Notice that, for convenience, the input signal $\mathbf{s}$
is also in the output set.

Concretelly, each \gls{SPRS} instance is generated (for the 2D case) using
the following algorithm:
\begin{enumerate}
\item \textbf{Separable 2D random shuffling of the samples of
    $\mathbf{X}$}: Let be two different pixels $\mathbf{X}_1$ and
  $\mathbf{X}_2$ with coordinates $(x_1, y_1)$ and $(x_2, y_2)$. This
  step performs the operation
  \begin{equation}
    \text{swap}_{xy}(\mathbf{X}_1,\mathbf{X}_2) = \{\text{swap}_x(\mathbf{X}_1,\mathbf{X}_2), \text{swap}_y(\mathbf{X}_1,\mathbf{X}_2)\},
  \end{equation}
  where
  \begin{equation}
    \text{swap}_x(\mathbf{X}_1,\mathbf{X}_2) = \text{swap}(x_1, x_2)\quad\text{if}~|x_1-x_2|<X,~X\sim\mathcal{N}(\sigma^2)
  \end{equation}
  and
  \begin{equation}
    \text{swap}_y(\mathbf{X}_1,\mathbf{X}_2) = \text{swap}(y_1, y_2)\quad\text{if}~|y_1-y_2|<X,~X\sim\mathcal{N}(\sigma^2),
  \end{equation}
  where $\text{swap}(a,b)$ performs
  \begin{equation}
    (a,b) \leftarrow (b,a).
  \end{equation}
  When these swappings are performed for all the pixels of
  $\mathbf{X}$, this step generates a randomly locally-shuffled image
  $\hat{\mathbf{X}}$. Notice that no pixels are lost, only displaced.

\item \textbf{Projection of $\mathbf{X}$ on $\hat{\mathbf{X}}$}:
  \begin{enumerate}
  \item \textbf{Computation of a \gls{DOF} field
      $\overrightarrow{\mathbf{V}}$}: We use the \gls{DOF} Farneb\"ack
    algorithm \cite{farneback2003two} to find a correspondence between
    the pixels of $\mathbf{X}$ and $\hat{\mathbf{X}}$ in terms of a
    spatial displacement (a vector) for each pixel of
    $\mathbf{X}$. Specifically, $\overrightarrow{\mathbf{V}}$ maps each
    pixel of $\mathbf{X}$ into a coordinate of $\hat{\mathbf{X}}$,
    where the coordinate components can be floating point numbers.
  \item \textbf{Project $\mathbf{X}$ using
      $\overrightarrow{\mathbf{V}}$}: Each pixel $\mathbf{X}_i$
    with coordinates $(i_x, i_y)$ is replaced by the bilinear
    interpolation of the four pixels of $\hat{\mathbf{X}}$ closer to
    the coordinate $(i_x+V_i.x,i_y+V_i.y)$, resulting
    $\tilde{\mathbf{X}}$.
  \end{enumerate}
\end{enumerate}

In conclusion, by applying Gaussian-distributed local perturbations to
pixel indices and a \gls{DOF} projection, \gls{SPRS} generates a local
randomization (from a visual point of view) of the structures of the
input image.

%}}}

\end{subappendices}